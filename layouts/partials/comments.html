<!-- {{- /* Giscus Comments */ -}} -->
{{ if .Site.Params.giscus.repo }}
<div class="giscus-comments">
    <script src="https://giscus.app/client.js"
        data-repo="{{ .Site.Params.giscus.repo }}"
        data-repo-id="{{ .Site.Params.giscus.repoId }}"
        data-category="{{ .Site.Params.giscus.category }}"
        data-category-id="{{ .Site.Params.giscus.categoryId }}"
        data-mapping="{{ .Site.Params.giscus.mapping }}"
        data-strict="{{ .Site.Params.giscus.strict }}"
        data-reactions-enabled="{{ .Site.Params.giscus.reactionsEnabled }}"
        data-emit-metadata="{{ .Site.Params.giscus.emitMetadata }}"
        data-input-position="{{ .Site.Params.giscus.inputPosition }}"
        data-theme="{{ .Site.Params.giscus.theme }}"
        data-lang="{{ .Site.Params.giscus.lang }}"
        data-loading="{{ .Site.Params.giscus.loading }}"
        crossorigin="anonymous"
        async>
    </script>
</div>

<script>
let updateThemeTimeout;

// Function to update giscus theme
function updateGiscusTheme() {
    const giscusFrame = document.querySelector('iframe.giscus-frame');
    if (!giscusFrame || !giscusFrame.contentWindow) return;
    
    // Determine current theme
    const storedTheme = localStorage.getItem("pref-theme");
    const isDark = document.body.classList.contains('dark');
    
    let theme;
    if (storedTheme === 'auto' || !storedTheme) {
        theme = isDark ? 'dark' : 'light';
    } else if (isDark || storedTheme === 'dark') {
        theme = 'dark';
    } else {
        theme = 'light';
    }
    
    // Send message to giscus iframe
    try {
        giscusFrame.contentWindow.postMessage({
            giscus: {
                setConfig: {
                    theme: theme
                }
            }
        }, 'https://giscus.app');
    } catch (error) {
        console.debug('Giscus theme update failed:', error);
    }
}

// Debounced theme update function
function debouncedUpdateTheme() {
    clearTimeout(updateThemeTimeout);
    updateThemeTimeout = setTimeout(updateGiscusTheme, 50);
}

// Wait for giscus to load, then update theme
function waitForGiscusAndUpdateTheme() {
    const checkGiscus = () => {
        const giscusFrame = document.querySelector('iframe.giscus-frame');
        if (giscusFrame && giscusFrame.contentWindow) {
            updateGiscusTheme();
        } else if (document.querySelector('.giscus-comments script')) {
            // Giscus script exists but iframe not ready yet
            setTimeout(checkGiscus, 100);
        }
    };
    checkGiscus();
}

// Update theme when page loads
document.addEventListener('DOMContentLoaded', waitForGiscusAndUpdateTheme);

// Listen for theme toggle events with immediate response
document.addEventListener('click', (e) => {
    if (e.target.closest('#theme-toggle')) {
        // Use requestAnimationFrame for smooth transition
        requestAnimationFrame(() => {
            requestAnimationFrame(updateGiscusTheme);
        });
    }
});

// Listen for system theme changes
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    const storedTheme = localStorage.getItem("pref-theme");
    if (storedTheme === 'auto' || !storedTheme) {
        debouncedUpdateTheme();
    }
});

// Listen for body class changes (theme changes)
const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            debouncedUpdateTheme();
        }
    });
});

observer.observe(document.body, {
    attributes: true,
    attributeFilter: ['class']
});
</script>
{{ end }}